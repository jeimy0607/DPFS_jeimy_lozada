<nav class="navbar">

    <button class="hamburger" id="navToggle" aria-label="Abrir menú" aria-expanded="false">
  <span></span><span></span><span></span>
</button>

    <ul class="menu">
        <li><a href="/">Inicio</a></li>
        <li><a href="/producto">Productos</a></li>
    </ul>

   
    <div class="logo">
        <img src="/public/images/logo.png" alt="Logo">
    </div>

  
    <ul class="menu2">
        <li class="nav-search">
    <a href="/buscador"><img src="/public/images/search.png" alt="Buscar"></a>
  </li>

        <% if (!user) { %>
  <li class="nav-user">
    <a href="/login">
      <img src="/public/images/user.png" alt="Iniciar Sesion">
    </a>
  </li>
<% } else { %>
  <li class="nav-user user-menu">
    <a href="#" id="userBtn" class="user-btn">
      <img class="user-avatar"
           src="<%= user.foto ? user.foto : '/public/images/user.png' %>"
           alt="Perfil">
    </a>

    <div id="userDropdown" class="user-dropdown">
      <p class="user-name"><%= user.nombre %></p>

      <% if (user.rol === "admin") { %>
        
        <a href="/producto">Administrar productos</a>
        <a href="/producto/desactivados">Productos desactivados</a>
      <% } %>

      <a href="/login/logout">Cerrar sesión</a>
    </div>
  </li>
<% } %>


        <li class="nav-cart">
  <% if (!user) { %>
    <a href="/login">
      <img src="/public/images/shopping.png" alt="Carrito">
    </a>
  <% } else { %>
    <a href="/carrito" id="carritoBtn">
      <img src="/public/images/shopping.png" alt="Carrito">
    </a>
  <% } %>
</li>
    </ul>

</nav>

<div id="carritoPanel" class="carrito-panel">
   <button type="button" class="carrito-close" id="carritoClose" aria-label="Cerrar carrito">✕</button>

  <div id="carritoContenido">
    <h2>Carrito</h2>
    <p>Cargando...</p>
  </div>
</div>


<div id="overlay" class="overlay"></div>


<div id="mobileMenu" class="mobile-menu">
  <ul class="mobile-links">
  <li><a href="/">Inicio</a></li>
  <li><a href="/producto">Productos</a></li>
  <li><a href="/buscador">Buscador</a></li>

  <% if (!user) { %>
    <li><a href="/login">Iniciar sesión</a></li>
  <% } else { %>
    <% if (user.rol === "admin") { %>
      <li><a href="/producto">Administrar productos</a></li>
      <li><a href="/producto/desactivados">Productos desactivados</a></li>
    <% } %>
    <li><a href="/login/logout">Cerrar sesión</a></li>
  <% } %>
</ul>
</div>

<div id="navOverlay" class="nav-overlay"></div>



<script>
  (function(){
    const carritoBtn = document.getElementById("carritoBtn");
    const carritoPanel = document.getElementById("carritoPanel");
    const overlay = document.getElementById("overlay");
    const carritoContenido = document.getElementById("carritoContenido");
    const carritoClose = document.getElementById("carritoClose");

    if (!carritoPanel || !overlay) return;

    function openCartPanel() {
      carritoPanel.classList.add("activo");
      overlay.classList.add("activo");
    }

    function closeCartPanel() {
      carritoPanel.classList.remove("activo");
      overlay.classList.remove("activo");
    }


    overlay.addEventListener("click", closeCartPanel);
    if (carritoClose) carritoClose.addEventListener("click", closeCartPanel);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeCartPanel();
    });

    if (!carritoBtn || !carritoContenido) return;

    async function loadCartPanel() {
  const res = await fetch("/carrito/panel", {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  if (res.status === 401) {
    window.location.href = "/login";
    return;
  }

  carritoContenido.innerHTML = await res.text();
}

    carritoBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      openCartPanel();
      await loadCartPanel();
    });

    carritoPanel.addEventListener("submit", async (e) => {
      const form = e.target;
      if (!form.classList.contains("ajax-cart")) return;

      e.preventDefault();

      const res = await fetch(form.action, {
        method: "POST",
         headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      if (res.status === 401) {
        window.location.href = "/login";
      return;
      }

      carritoContenido.innerHTML = await res.text();
      });
      })();
</script>

<script>
  (function(){
    const toggle = document.getElementById("navToggle");
    const menu = document.getElementById("mobileMenu");
    const overlay = document.getElementById("navOverlay");

    if (!toggle || !menu || !overlay) return;

    function openMenu(){
      menu.classList.add("activo");
      overlay.classList.add("activo");
      toggle.setAttribute("aria-expanded", "true");
    }

    function closeMenu(){
      menu.classList.remove("activo");
      overlay.classList.remove("activo");
      toggle.setAttribute("aria-expanded", "false");
    }

    toggle.addEventListener("click", () => {
      menu.classList.contains("activo") ? closeMenu() : openMenu();
    });

    overlay.addEventListener("click", closeMenu);

    menu.addEventListener("click", (e) => {
      if (e.target.closest("a")) closeMenu();
    });

    
    window.addEventListener("resize", () => {
      if (window.innerWidth > 768) closeMenu();
    });
  })();
</script>


<script>
  (function () {
    const btn = document.getElementById("userBtn");
    const dd = document.getElementById("userDropdown");
    if (!btn || !dd) return;

    btn.addEventListener("click", (e) => {
      e.preventDefault();
      dd.classList.toggle("show");
    });

    document.addEventListener("click", (e) => {
      if (!dd.contains(e.target) && !btn.contains(e.target)) {
        dd.classList.remove("show");
      }
    });
  })();
</script>
